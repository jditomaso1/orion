// app/tools/deal-upload/page.tsx
"use client";

import { useCallback, useMemo, useRef, useState } from "react";
import { Upload, FileText, CheckCircle2, AlertCircle, Loader2, Trash2, X } from "lucide-react";

/**
 * Orion Deal Upload & Results (Frontend-only UI)
 * -------------------------------------------------
 * This page provides a production-quality UI for:
 *  - File selection (drag & drop or click)
 *  - Uploading a single PDF to /api/parse-pdf (Next.js server route)
 *  - Showing progress, success/error states
 *  - Rendering parsed fields in a clean Results card with confidence chips
 *  - Listing source documents for each field (if provided by backend)
 *
 * Assumptions:
 *  - TailwindCSS is configured in your project.
 *  - API route exists at /api/parse-pdf and returns JSON like:
 *      {
 *        fields: {
 *          "Deal Title": "...",
 *          "Company": "...",
 *          "Debt Amount": "...",
 *          "Term": "...",
 *          "Pricing": "...",
 *          "Use of Proceeds": "...",
 *          "Covenants": "..."
 *        },
 *        meta: { pages: 24 },
 *        confidence: { "Company": "High", ... },           // optional
 *        sources: { "Company": ["Credit_Agreement.pdf"], ... } // optional
 *      }
 */

export default function DealUploadPage() {
  const [file, setFile] = useState<File | null>(null);
  const [dragActive, setDragActive] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [result, setResult] = useState<any | null>(null);

  const inputRef = useRef<HTMLInputElement>(null);

  const onBrowseClick = useCallback(() => inputRef.current?.click(), []);

  const onFileChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const f = e.target.files?.[0] ?? null;
    if (f) setFile(f);
  }, []);

  const onDragOver = useCallback((e: React.DragEvent<HTMLDivElement>) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActive(true);
  }, []);

  const onDragLeave = useCallback((e: React.DragEvent<HTMLDivElement>) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActive(false);
  }, []);

  const onDrop = useCallback((e: React.DragEvent<HTMLDivElement>) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActive(false);
    const f = e.dataTransfer.files?.[0];
    if (f) setFile(f);
  }, []);

  const clearSelection = useCallback(() => setFile(null), []);
  const clearAll = useCallback(() => { setFile(null); setResult(null); setError(null); }, []);

  const prettySize = useMemo(() => {
    if (!file) return "";
    const kb = file.size / 1024;
    return kb > 1024 ? `${(kb/1024).toFixed(2)} MB` : `${kb.toFixed(0)} KB`;
  }, [file]);

  async function handleUpload(e: React.FormEvent) {
    e.preventDefault();
    setError(null);
    setResult(null);
    if (!file) return;

    if (!file.name.toLowerCase().endsWith(".pdf")) {
      setError("Please upload a PDF file.");
      return;
    }

    try {
      setLoading(true);
      const fd = new FormData();
      fd.append("file", file);

      const res = await fetch("/api/parse-pdf", { method: "POST", body: fd });
      const json = await res.json();

      if (!res.ok) {
        throw new Error(json?.error || "Parse failed. Please try again.");
      }
      setResult(json);
    } catch (err: any) {
      setError(err.message || "Something went wrong.");
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="min-h-screen bg-gray-50 text-gray-900">
      {/* Top Bar */}
      <header className="sticky top-0 z-20 bg-white/80 backdrop-blur border-b">
        <div className="mx-auto max-w-7xl px-6 h-14 flex items-center justify-between">
          <div className="font-semibold tracking-tight">Orion • Deal Upload</div>
          <button
            onClick={clearAll}
            className="inline-flex items-center gap-2 rounded-2xl px-3 py-1.5 text-sm ring-1 ring-gray-200 hover:bg-gray-100"
            title="Reset page"
          >
            <Trash2 className="w-4 h-4" /> Reset
          </button>
        </div>
      </header>

      <main className="mx-auto max-w-7xl px-6 py-10 grid grid-cols-1 lg:grid-cols-3 gap-8">
        {/* Left: Uploader */}
        <section className="lg:col-span-1">
          <div
            onDragOver={onDragOver}
            onDragLeave={onDragLeave}
            onDrop={onDrop}
            className={`rounded-3xl border-2 border-dashed p-8 bg-white transition ${
              dragActive ? "border-gray-900 bg-gray-50" : "border-gray-200"
            }`}
          >
            <div className="flex items-center justify-center">
              <div className="text-center space-y-3">
                <div className="mx-auto w-12 h-12 rounded-2xl bg-gray-100 flex items-center justify-center">
                  <Upload className="w-6 h-6" />
                </div>
                <h2 className="text-lg font-semibold">Upload a PDF</h2>
                <p className="text-sm text-gray-600">Drag & drop your credit agreement, CIM, or lender deck here — or browse.</p>

                <div className="flex items-center justify-center gap-3 pt-2">
                  <button
                    onClick={onBrowseClick}
                    className="rounded-2xl bg-black text-white px-4 py-2 text-sm hover:opacity-90"
                  >
                    Choose file
                  </button>
                  <span className="text-xs text-gray-500">PDF only</span>
                </div>

                <input
                  ref={inputRef}
                  type="file"
                  accept="application/pdf"
                  className="hidden"
                  onChange={onFileChange}
                />

                {file && (
                  <div className="mt-5 rounded-2xl ring-1 ring-gray-200 p-3 text-left bg-gray-50">
                    <div className="flex items-center gap-3">
                      <FileText className="w-5 h-5" />
                      <div className="flex-1 min-w-0">
                        <div className="truncate text-sm font-medium">{file.name}</div>
                        <div className="text-xs text-gray-500">{prettySize}</div>
                      </div>
                      <button onClick={clearSelection} className="p-1 rounded-lg hover:bg-white" title="Remove file">
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                )}

                <form onSubmit={handleUpload} className="pt-4">
                  <button
                    type="submit"
                    disabled={!file || loading}
                    className="w-full inline-flex items-center justify-center gap-2 rounded-2xl bg-gray-900 text-white px-4 py-2 text-sm disabled:opacity-50"
                  >
                    {loading ? (<><Loader2 className="w-4 h-4 animate-spin" /> Parsing…</>) : "Upload & Parse"}
                  </button>
                </form>

                {error && (
                  <div className="mt-4 rounded-2xl bg-red-50 text-red-800 ring-1 ring-red-200 p-3 text-sm flex items-start gap-2">
                    <AlertCircle className="w-4 h-4 mt-0.5" />
                    <div>
                      <div className="font-medium">Upload failed</div>
                      <div>{error}</div>
                    </div>
                  </div>
                )}

                {!error && !result && (
                  <div className="mt-4 text-xs text-gray-500">
                    Tip: For larger files, you can start with a single section to test the flow.
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Meta / Health */}
          <div className="mt-6 rounded-3xl bg-white ring-1 ring-gray-200 p-4">
            <div className="text-sm font-medium mb-2">Backend status</div>
            <HealthCheck />
          </div>
        </section>

        {/* Right: Results */}
        <section className="lg:col-span-2">
          <div className="rounded-3xl bg-white ring-1 ring-gray-200 p-6 min-h-[320px]">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold">Results</h3>
              {result && (
                <span className="inline-flex items-center gap-1.5 text-xs rounded-xl bg-green-50 text-green-800 ring-1 ring-green-200 px-2 py-1">
                  <CheckCircle2 className="w-3.5 h-3.5" /> Parsed
                </span>
              )}
            </div>

            {!result && !loading && (
              <EmptyState />
            )}

            {loading && (
              <div className="flex flex-col items-center justify-center h-48 gap-3">
                <Loader2 className="w-6 h-6 animate-spin" />
                <div className="text-sm text-gray-600">Extracting fields…</div>
              </div>
            )}

            {result && (
              <ResultsView data={result} />
            )}
          </div>
        </section>
      </main>
    </div>
  );
}

function EmptyState() {
  return (
    <div className="grid place-items-center h-48 text-center">
      <div className="space-y-2">
        <div className="text-sm text-gray-600">No results yet</div>
        <div className="text-xs text-gray-500">Upload a PDF on the left to see extracted fields here.</div>
      </div>
    </div>
  );
}

function HealthCheck() {
  const [status, setStatus] = useState<"idle" | "ok" | "down" | "loading">("idle");
  const [detail, setDetail] = useState<string>("");

  async function ping() {
    try {
      setStatus("loading");
      setDetail("");
      const res = await fetch("/api/health", { method: "GET" });
      const json = await res.json();
      if (res.ok && (json?.ok || json?.status === "ok")) {
        setStatus("ok");
        setDetail(JSON.stringify(json));
      } else {
        setStatus("down");
        setDetail(JSON.stringify(json));
      }
    } catch (e: any) {
      setStatus("down");
      setDetail(e?.message ?? "Network error");
    }
  }

  return (
    <div className="flex items-center justify-between gap-3">
      <div className="text-xs text-gray-600">
        {status === "idle" && "Press ping to check backend health."}
        {status === "loading" && "Pinging…"}
        {status === "ok" && "Backend reported OK."}
        {status === "down" && "Backend not reachable."}
      </div>
      <button onClick={ping} className="rounded-xl px-3 py-1.5 text-xs ring-1 ring-gray-200 hover:bg-gray-100">Ping</button>
    </div>
  );
}

function ResultsView({ data }: { data: any }) {
  const fields: Record<string, string | null> = data?.fields ?? {};
  const meta: Record<string, any> = data?.meta ?? {};
  const confidence: Record<string, string> = data?.confidence ?? {};
  const sources: Record<string, string[]> = data?.sources ?? {};

  const entries = Object.entries(fields);

  if (!entries.length) {
    return (
      <div className="text-sm text-gray-600">
        No structured fields returned. Try a different PDF or check the backend logic.
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Meta */}
      <div className="flex flex-wrap items-center gap-3 text-xs text-gray-600">
        {typeof meta?.pages === "number" && (
          <span className="inline-flex items-center gap-2 rounded-xl bg-gray-50 ring-1 ring-gray-200 px-2 py-1">
            <FileText className="w-3.5 h-3.5" /> {meta.pages} pages
          </span>
        )}
      </div>

      {/* Fields table */}
      <div className="overflow-hidden rounded-2xl ring-1 ring-gray-200">
        <table className="w-full text-sm">
          <thead className="bg-gray-50 text-gray-600">
            <tr>
              <th className="text-left font-medium p-3 w-[22%]">Field</th>
              <th className="text-left font-medium p-3">Value</th>
              <th className="text-left font-medium p-3 w-[18%]">Confidence</th>
              <th className="text-left font-medium p-3 w-[28%]">Source docs</th>
            </tr>
          </thead>
          <tbody>
            {entries.map(([key, value], idx) => (
              <tr key={key} className={idx % 2 ? "bg-white" : "bg-gray-50/50"}>
                <td className="align-top p-3 font-medium text-gray-900">{key}</td>
                <td className="align-top p-3 text-gray-800">
                  {value ? (
                    <span className="whitespace-pre-wrap break-words">{value}</span>
                  ) : (
                    <span className="italic text-gray-500">Not provided</span>
                  )}
                </td>
                <td className="align-top p-3">
                  <ConfidencePill level={confidence?.[key]} />
                </td>
                <td className="align-top p-3">
                  <SourceChips items={sources?.[key]} />
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Raw JSON toggle */}
      <details className="rounded-2xl bg-gray-50 ring-1 ring-gray-200 p-4">
        <summary className="text-sm font-medium cursor-pointer">Raw response</summary>
        <pre className="mt-3 text-xs overflow-auto">{JSON.stringify(data, null, 2)}</pre>
      </details>
    </div>
  );
}

function ConfidencePill({ level }: { level?: string }) {
  if (!level) return <span className="text-xs text-gray-400">—</span>;
  const map: Record<string, string> = {
    High: "bg-green-50 text-green-800 ring-green-200",
    Medium: "bg-amber-50 text-amber-800 ring-amber-200",
    Low: "bg-red-50 text-red-800 ring-red-200",
  };
  const klass = map[level] ?? "bg-gray-50 text-gray-800 ring-gray-200";
  return (
    <span className={`inline-flex items-center rounded-xl px-2 py-1 text-xs ring-1 ${klass}`}>{level}</span>
  );
}

function SourceChips({ items }: { items?: string[] }) {
  if (!items || !items.length) return <span className="text-xs text-gray-400">—</span>;
  return (
    <div className="flex flex-wrap gap-1.5">
      {items.map((s) => (
        <span key={s} className="inline-flex items-center rounded-xl bg-white ring-1 ring-gray-200 px-2 py-0.5 text-xs">
          {s}
        </span>
      ))}
    </div>
  );
}
