<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stock Quote</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
    .wrap { max-width: 860px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 16px; margin-top: 12px; }
    .muted { color:#666; font-size: 12px; }
    .title { display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; }
    .sym { font-size: 20px; font-weight: 800; }
    .name { font-size: 14px; color:#444; }
    .big { font-size: 40px; font-weight: 900; margin: 8px 0 4px; }
    .chg { font-weight: 800; }
    .pos { color: #0a7a2f; }
    .neg { color: #b00020; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    td { padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px; }
    td:first-child { color:#444; }
    .error { color:#b00020; font-weight: 700; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .pill { display:inline-flex; gap:6px; align-items:center; padding:4px 10px; border:1px solid #eee; border-radius: 999px; font-size:12px; color:#444; background:#fafafa; }
  </style>
</head>

<body class="flex">

  <!-- SIDEBAR -->
  <div id="sidebar-placeholder"></div>
  <script>
    async function injectSidebar() {
      const res = await fetch("/private-credit/sidebar.html");
      document.getElementById("sidebar-placeholder").innerHTML = await res.text();

      window.toggleSection = function(id) {
        const section = document.getElementById(id);
        const icon = document.getElementById("icon-" + id);
        if (!section || !icon) return;

        section.classList.toggle("hidden");
        icon.style.transform = section.classList.contains("hidden") ? "rotate(0deg)" : "rotate(90deg)";
        localStorage.setItem("sidebar-open-section", id);
      };

      const last = localStorage.getItem("sidebar-open-section");
      if (last) {
        const s = document.getElementById(last);
        const i = document.getElementById("icon-" + last);
        if (s && i) {
          s.classList.remove("hidden");
          i.style.transform = "rotate(90deg)";
        }
      }
    }
    injectSidebar();
  </script>

  <!-- MAIN CONTENT -->
  <div class="wrap">
    <div class="title">
      <div class="sym" id="sym">—</div>
      <div class="name" id="name"></div>
      <span class="pill" id="asof" style="display:none;"></span>
    </div>
    <div class="muted">
      Source: <code>/api/finnhub-quote</code> (Finnhub key stays server-side)
    </div>

    <div class="card" id="out">
      <div class="muted" id="status">Loading…</div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function fmtNumber(x, decimals = 2) {
      const n = Number(x);
      if (!Number.isFinite(n)) return "—";
      return n.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }

    function fmtInt(x) {
      if (x == null || x === "") return "—";
      const n = Number(x);
      if (!Number.isFinite(n)) return "—";
      return n.toLocaleString();
    }

    function fmtMoney(x) {
      if (x == null) return "—";
      return `$${fmtNumber(x, 2)}`;
    }

    function renderError(title, detail) {
      $("out").innerHTML = `
        <div class="error">${title}</div>
        ${detail ? `<div class="muted" style="margin-top:6px;">${detail}</div>` : ""}
      `;
    }

    function render(data) {
      const symbol = data.symbol || "—";
      const name = data.name || "";
      const asOf = data.asOf || data.latestTradingDay || null;

      $("sym").textContent = symbol;
      $("name").textContent = name;

      if (asOf) {
        $("asof").style.display = "inline-flex";
        $("asof").textContent = `As of: ${asOf}`;
      }

      const price = data.price;
      const change = data.change;
      const changePercent = data.changePercent;
      const isNeg = String(change || "").trim().startsWith("-");

      $("out").innerHTML = `
        <div class="big">${price ? fmtMoney(price) : "—"}</div>
        <div class="chg ${isNeg ? "neg" : "pos"}">
          ${change ? `${isNeg ? "" : "+"}${fmtNumber(change, 2)} (${changePercent || "—"})` : "—"}
        </div>

        <table>
          <tr><td>Previous Close</td><td style="text-align:right;">${fmtMoney(data.previousClose)}</td></tr>
          <tr><td>Open</td><td style="text-align:right;">${fmtMoney(data.open)}</td></tr>
          <tr><td>High</td><td style="text-align:right;">${fmtMoney(data.high)}</td></tr>
          <tr><td>Low</td><td style="text-align:right;">${fmtMoney(data.low)}</td></tr>
          <tr><td>Volume</td><td style="text-align:right;">${fmtInt(data.volume)}</td></tr>
        </table>

        <div class="muted" style="margin-top:10px;">
          Market cap: <b>${data.marketCap ? Number(data.marketCap).toLocaleString() : "—"}</b>
          &nbsp;•&nbsp; P/E (TTM): <b>${data.peRatioTTM || "—"}</b>
          &nbsp;•&nbsp; EPS (TTM): <b>${data.epsTTM || "—"}</b>
        </div>
      `;
    }

    async function load() {
      const params = new URLSearchParams(window.location.search);
      const symbol = (params.get("symbol") || "PLAY").trim().toUpperCase();

      try {
        const url = new URL("/api/finnhub-quote", window.location.origin);
        url.searchParams.set("symbol", symbol);

        const res = await fetch(url.toString(), { headers: { "Accept": "application/json" } });
        let data = null;
        try { data = await res.json(); } catch {}

        if (!res.ok) {
          const msg = (data && (data.error || data.Note || data["Error Message"])) || `HTTP ${res.status}`;
          renderError("Backend error:", String(msg));
          return;
        }

        if (!data || data.error) {
          renderError("No data returned.", data && data.error ? String(data.error) : "");
          return;
        }

        render(data);
      } catch (e) {
        renderError("Request failed.", String(e));
      }
    }

    load();
  </script>
  <!-- Chat Logic -->
  <script>
    const input = document.getElementById("chatInput");
    const btn = document.getElementById("sendBtn");
    const windowEl = document.getElementById("chatWindow");

    function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      const msg = document.createElement("div");
      msg.className = "flex items-start gap-3";

      msg.innerHTML = `
        <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-semibold">J</div>
        <div>
          <div class="font-semibold text-gray-800">You <span class="text-gray-400 text-xs ml-2">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></div>
          <div class="bg-blue-50 p-3 rounded-lg text-sm text-gray-800 max-w-xl border border-blue-200">
            ${text}
          </div>
        </div>
      `;

      windowEl.appendChild(msg);
      windowEl.scrollTop = windowEl.scrollHeight;

      input.value = "";
    }

    btn.onclick = sendMessage;
    input.addEventListener("keypress", e => {
      if (e.key === "Enter") sendMessage();
    });
  </script>
    <!--Ask Orion Bot -->
    <div id="orion-chat-include"></div>
    <script>
      async function loadOrionChat() {
        const res = await fetch("/private-credit/includes/orion-chat.html");
        const html = await res.text();
    
        // Insert into DOM
        const container = document.getElementById("orion-chat-include");
        container.innerHTML = html;
    
        // --- EXECUTE SCRIPTS ---
        const scripts = container.querySelectorAll("script");
        scripts.forEach(oldScript => {
          const newScript = document.createElement("script");
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          document.body.appendChild(newScript);
          oldScript.remove();
        });
      }
    
      loadOrionChat();
    </script>
</body>
</html>
