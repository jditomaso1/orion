<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Credit Tear Sheet — Orion | Dave & Buster’s</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon -->
  <link rel="icon" type="image/png"
        href="https://raw.githubusercontent.com/jditomaso1/private-credit-marketing/main/img/favicon.png?v=2" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; background: #f5f6f8; }

    /* Confidence colors */
    .confidence-high   { color: #16a34a; font-weight: 600; }
    .confidence-medium { color: #ea580c; font-weight: 500; }
    .confidence-low    { color: #b45309; }
    .confidence-none   { color: #9ca3af; }

    /* PRINT */
    @media print {
      @page { size: A4; margin: 10mm; }

      nav, .sidebar, #sidebar-placeholder, .ask-orion-container, button, input, textarea,
      .no-print, #orion-chat-include {
        display: none !important;
      }

      .ml-64 { margin-left: 0 !important; }
      .flex-1 { width: 100% !important; max-width: 100% !important; padding: 0 !important; }

      body, .bg-white { background: white !important; box-shadow: none !important; }
      .rounded, .rounded-lg, .rounded-2xl { border-radius: 0 !important; }

      section { page-break-inside: avoid !important; break-inside: avoid !important; }

      table { width: 100% !important; border-collapse: collapse !important; font-size: 11px !important; }
      th, td { border: 1px solid #ccc !important; padding: 4px !important; }

      * {
        color: #000 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
    }
  </style>
</head>

<body class="flex min-h-screen">

  <!-- SIDEBAR -->
  <div id="sidebar-placeholder"></div>
  <script>
    async function injectSidebar() {
      const res = await fetch("/dnb/sidebar.html");
      document.getElementById("sidebar-placeholder").innerHTML = await res.text();

      window.toggleSection = function (id) {
        const section = document.getElementById(id);
        const icon = document.getElementById("icon-" + id);
        if (!section || !icon) return;
        section.classList.toggle("hidden");
        icon.style.transform = section.classList.contains("hidden") ? "rotate(0deg)" : "rotate(90deg)";
        localStorage.setItem("sidebar-open-section", id);
      };

      const last = localStorage.getItem("sidebar-open-section");
      if (last) {
        const section = document.getElementById(last);
        const icon = document.getElementById("icon-" + last);
        if (section && icon) {
          section.classList.remove("hidden");
          icon.style.transform = "rotate(90deg)";
        }
      }
    }
    injectSidebar();
  </script>

  <!-- MAIN WRAPPER -->
  <div class="flex-1 ml-64 px-4 py-8">

    <!-- HEADER -->
    <header class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold text-gray-900" id="page-title">
          Orion | Credit Tear Sheet
        </h1>
        <p class="text-sm text-gray-500 mt-1" id="page-subtitle">
          Loading deal stack via FastAPI…
        </p>
      </div>
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
          Beta
        </span>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-900 text-white">
          Internal Use
        </span>
        <button onclick="window.print()"
          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-600 text-white hover:bg-blue-700 shadow-sm">
          Print
        </button>
      </div>
    </header>

    <!-- COMPANY SNAPSHOT -->
    <section class="mb-6">
      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 md:p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h2 class="text-xl font-semibold text-gray-900">Company Snapshot</h2>
            <p class="text-sm text-gray-500 mt-1">
              High-level view of the issuer and current market context.
            </p>
          </div>
          <div class="flex flex-wrap gap-2 text-xs">
            <span class="px-3 py-1 rounded-full bg-gray-100 text-gray-700 font-medium" id="updated-pill">
              Updated: —
            </span>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
          <div>
            <div class="text-gray-500 text-xs uppercase tracking-wide">Company</div>
            <div class="font-semibold text-gray-900" id="snap-company">—</div>
            <div class="text-xs text-gray-500" id="snap-ticker">Ticker: —</div>
          </div>

          <div>
            <div class="text-gray-500 text-xs uppercase tracking-wide">Sector / Subsector</div>
            <div class="font-semibold text-gray-900" id="snap-sector">—</div>
            <div class="text-xs text-gray-500" id="snap-subsector">—</div>
          </div>

          <div>
            <div class="text-gray-500 text-xs uppercase tracking-wide">Ownership / Sponsor</div>
            <div class="font-semibold text-gray-900" id="snap-ownership">—</div>
            <div class="text-xs text-gray-500" id="snap-sponsor">—</div>
          </div>

          <div>
            <div class="text-gray-500 text-xs uppercase tracking-wide">Credit Rating</div>
            <div class="font-semibold text-gray-900" id="snap-rating">—</div>
            <div class="text-xs text-gray-500" id="snap-rating-note">—</div>
          </div>
        </div>

        <div class="mt-4 text-sm text-gray-700" id="snap-business">
          <span class="font-semibold">Business Model:</span> —
        </div>
      </div>
    </section>

    <!-- TOP METRICS STRIP (LIVE) -->
    <section class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4" id="metrics-strip">
      <!-- filled dynamically -->
    </section>

    <!-- MAIN GRID -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- LEFT (2/3) -->
      <div class="lg:col-span-2 space-y-6">

        <!-- MASTER TEARSHEET (Pawsitive fields) -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 md:p-6">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-gray-900">Master Tearsheet (Merged)</h2>
            <span class="text-xs text-gray-500">Values + sources + confidence</span>
          </div>

          <div id="master-fields" class="space-y-6 text-sm text-gray-800"></div>
        </section>

        <!-- PDF TEMPLATE REQUIRED PARAMETERS (Expert schema) -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 md:p-6">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-gray-900">Required Parameters (Expert Template)</h2>
            <span class="text-xs text-gray-500">Same engine, stricter schema</span>
          </div>

          <div class="text-xs text-gray-500 mb-4">
            This section matches the “expert” credit memo template style (Recommendation, Company Overview, Positives/Negatives, Liquidity, Collateral, Asset Coverage, Structure Details, etc.).
            Anything not returned by your backend will show as <span class="font-semibold">Not Provided</span> until you add extraction for it.
          </div>

          <div id="required-fields" class="space-y-6 text-sm text-gray-800"></div>
        </section>

        <!-- FINAL JSON VIEW -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 md:p-6">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-gray-900">Final JSON</h2>
            <span class="text-xs text-gray-500">Master summary object</span>
          </div>
          <details class="text-xs">
            <summary class="cursor-pointer text-gray-600">Show JSON</summary>
            <pre id="json-output" class="mt-3 p-3 bg-gray-100 rounded-lg overflow-x-auto text-[11px] leading-snug">{}</pre>
          </details>
        </section>

      </div>

      <!-- RIGHT (1/3) -->
      <div class="space-y-6">

        <!-- STRATEGY -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 md:p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-2">Strategy Recommendation</h2>
          <div id="strategy-pill"
               class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-50 text-purple-800 border border-purple-200">
            Loading…
          </div>
          <p class="text-sm text-gray-700 leading-relaxed mt-3" id="strategy-detail">
            —
          </p>
        </section>

        <!-- FILES USED -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 md:p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-3">Files Used</h2>
          <ul class="text-sm text-gray-700 space-y-2" id="files-used-list"></ul>
          <p class="mt-3 text-xs text-gray-500">
            Click any source label under a field to open the exact snippet (via <code>/field-source-snippet</code>).
          </p>
        </section>

        <!-- EXPORT -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 md:p-6 no-print">
          <h2 class="text-lg font-semibold text-gray-900 mb-3">Export</h2>
          <div class="flex flex-wrap gap-2 text-xs">
            <button class="border px-2 py-1 rounded-lg hover:bg-gray-50" id="btn-json">JSON</button>
            <button class="border px-2 py-1 rounded-lg hover:bg-gray-50" id="btn-csv">CSV</button>
            <button class="border px-2 py-1 rounded-lg hover:bg-gray-50" id="btn-text">Text</button>
          </div>
        </section>

      </div>
    </div>

  </div>

  <!-- Ask Orion Bot -->
  <div id="orion-chat-include"></div>
  <script>
    async function loadOrionChat() {
      const res = await fetch("/dnb/includes/orion-chat.html");
      const html = await res.text();

      const container = document.getElementById("orion-chat-include");
      container.innerHTML = html;

      const scripts = container.querySelectorAll("script");
      scripts.forEach(oldScript => {
        const newScript = document.createElement("script");
        if (oldScript.src) newScript.src = oldScript.src;
        else newScript.textContent = oldScript.textContent;
        document.body.appendChild(newScript);
        oldScript.remove();
      });
    }
    loadOrionChat();
  </script>

  <!-- CORE LOGIC -->
  <script>
    /* ==========================
       CONFIG
    ========================== */

    const ORION_API_BASE = "http://127.0.0.1:8000";

    const DEAL_FILE_IDS = [
      "1gnjiw485nzbcs6mmkNLC61LGbAd5RUCR", // Credit Agreement
      "13MghCjeTqVFrfvrbc8P3Vr_YauW5_biJ"  // 10-K 2025
    ];

    const FILE_LABELS = {
      "1gnjiw485nzbcs6mmkNLC61LGbAd5RUCR": "Credit Agreement",
      "13MghCjeTqVFrfvrbc8P3Vr_YauW5_biJ": "10-K (2025)"
    };

    /* ==========================
       SCHEMAS (UI wants these)
    ========================== */

    const MASTER_SCHEMA = {
      sections: {
        "Deal Overview": [
          "Deal Title","Company Name","Industry","Business Description","Ownership","Sponsor","Deal Status"
        ],
        "Financials": [
          "Revenue (LTM, $mm)","EBITDA (LTM, $mm)","EBITDA Margin (%)","CapEx (LTM, $mm)","Cash on Balance Sheet ($mm)"
        ],
        "Structure & Terms": [
          "Debt Amount (New Loan, $mm)","Use of Proceeds","Term (Years)","Interest Rate / Pricing","Structure",
          "Equity Contribution (%)","Leverage (Gross)","Leverage (Net)","Security","Covenants"
        ],
        "Analysis & Commentary": [
          "Key Strengths","Key Risk Factors","Notes / Commentary"
        ]
      }
    };

    const REQUIRED_SCHEMA = {
      sections: {
        "Recommendation": [
          "RECOMMENDATION",
          "Recommendation Rationale"
        ],
        "Company Overview": [
          "COMPANY OVERVIEW",
          "BRIEF COMPANY DESCRIPTION",
          "INDUSTRY",
          "PRODUCT OFFERING",
          "BRANDS",
          "DISTRIBUTION"
        ],
        "Positives / Negatives": [
          "POSITIVES",
          "NEGATIVES",
          "2022 CHALLENGES"
        ],
        "Structure Details": [
          "STRUCTURE DETAILS",
          "Debt Structure Summary",
          "Pricing / Spread",
          "Maturity / Term",
          "Covenant Package",
          "Security / Collateral"
        ],
        "Collateral & Guarantees": [
          "COLLATERAL SUMMARY",
          "BORROWER / GUARANTORS",
          "Guarantees / Guarantor Coverage",
          "INTELLECTUAL PROPERTY"
        ],
        "Asset Coverage": [
          "ASSET COVERAGE DETAIL",
          "Asset Coverage Summary",
          "Recovery / Haircut Assumptions"
        ],
        "Liquidity / Working Capital": [
          "LIQUIDITY",
          "WORKING CAPITAL AND OTHER ASSETS",
          "Cash",
          "Revolver Availability",
          "Near-Term Maturities"
        ],
        "CapEx / Cost Structure": [
          "CAPEX",
          "COST STRUCTURE",
          "PROCUREMENT"
        ],
        "Valuation / Capitalization": [
          "CURRENT CAPITALIZATION AND VALUATION"
        ]
      }
    };

    /* ==========================
       ALIAS MAP (backend -> UI)
       This is what makes it look “complete” using the data you already have.
    ========================== */

    const FIELD_ALIASES = {
      // Snapshot / company basics
      "Company Name": ["Company Name", "Borrower / Issuer"],
      "Industry": ["Industry", "Sector"],
      "Business Description": ["Business Description", "Segments (names + revenue/profit if disclosed)"],
      "Deal Title": ["Deal Title"],
      "Sponsor": ["Sponsor", "Ownership"],
      "Ownership": ["Ownership", "Parent / HoldCo (if any)"],

      // Financials (your backend is returning Period fields, not LTM)
      "Revenue (LTM, $mm)": ["Revenue (LTM, $mm)", "Revenue (Period, $mm)"],
      "EBITDA (LTM, $mm)": ["EBITDA (LTM, $mm)", "Adjusted EBITDA (If stated, $mm)", "EBITDA (Period, $mm)"],
      "EBITDA Margin (%)": ["EBITDA Margin (%)", "Gross Margin (%)"],
      "CapEx (LTM, $mm)": ["CapEx (LTM, $mm)", "CapEx (Period, $mm)"],
      "Cash on Balance Sheet ($mm)": ["Cash on Balance Sheet ($mm)", "Cash & Cash Equivalents ($mm)"],

      // Structure / terms (using what we saw in your curl)
      "Debt Amount (New Loan, $mm)": ["Debt Amount (New Loan, $mm)", "Total Debt ($mm)"],
      "Use of Proceeds": ["Use of Proceeds", "Purpose / Use of Proceeds"],
      "Term (Years)": ["Term (Years)", "Term (Years) (if stated)"],
      "Interest Rate / Pricing": ["Interest Rate / Pricing", "Pricing / Spread", "Commitment Fee (Revolver)", "Default Interest Rate (if any)"],
      "Structure": ["Structure", "Deal Title"],
      "Security": ["Security", "Collateral Package (summary)"],
      "Covenants": ["Covenants", "Events of Default (list)"],

      // Commentary
      "Notes / Commentary": ["Notes / Commentary", "Remedies (high-level)", "Remedies", "Jurisdiction / Venue", "Governing Law"]
    };

    /* ==========================
       HELPERS
    ========================== */

    function computeConfidence(count) {
      if (count >= 3) return "High";
      if (count === 2) return "Medium";
      if (count === 1) return "Low";
      return "None";
    }

    function confidenceClass(conf) {
      return conf === "High" ? "confidence-high" :
             conf === "Medium" ? "confidence-medium" :
             conf === "Low" ? "confidence-low" : "confidence-none";
    }

    function formatValue(val) {
      if (Array.isArray(val)) {
        if (!val.length) return "Not Provided";
        return val.map(v => String(v)).join(" • ");
      }
      if (val && typeof val === "object") return JSON.stringify(val, null, 2);
      const s = String(val ?? "");
      return s.trim() === "" ? "Not Provided" : s;
    }

    function safeText(x, fallback="—") {
      const s = String(x ?? "").trim();
      return s ? s : fallback;
    }

    function normalizeNumber(x) {
      if (x === null || x === undefined) return null;
      const n = Number(String(x).replace(/[^0-9.\-]/g, ""));
      return Number.isFinite(n) ? n : null;
    }

    function downloadBlob(data, filename, type) {
      const blob = new Blob([data], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function getAny(obj, keys, fallback="Not Provided") {
      for (const k of keys) {
        if (obj && Object.prototype.hasOwnProperty.call(obj, k)) {
          const v = obj[k];
          if (v !== null && v !== undefined && String(v).trim() !== "") return v;
        }
      }
      return fallback;
    }

    // Returns { value, sourceKeyUsed }
    function getAliasedValue(summary, uiField) {
      const keys = FIELD_ALIASES[uiField] || [uiField];
      for (const k of keys) {
        if (summary && Object.prototype.hasOwnProperty.call(summary, k)) {
          const v = summary[k];
          if (v !== null && v !== undefined && String(v).trim() !== "") {
            return { value: v, keyUsed: k };
          }
        }
      }
      return { value: "Not Provided", keyUsed: null };
    }

    function renderFilesUsed() {
      const ul = document.getElementById("files-used-list");
      if (!ul) return;

      ul.innerHTML = DEAL_FILE_IDS.map((id, idx) => {
        const label = FILE_LABELS[id] || id;
        const driveUrl = `https://drive.google.com/file/d/${id}/view`;
        return `<li>${idx+1}) <a class="text-blue-600 underline" href="${driveUrl}" target="_blank">${label}</a></li>`;
      }).join("");
    }

    function renderMetricsStrip(summary) {
      const container = document.getElementById("metrics-strip");
      if (!container) return;

      const rev  = getAny(summary, ["Revenue (LTM, $mm)", "Revenue (Period, $mm)"], null);
      const ebit = getAny(summary, ["EBITDA (LTM, $mm)", "Adjusted EBITDA (If stated, $mm)", "EBITDA (Period, $mm)"], null);
      const marg = getAny(summary, ["EBITDA Margin (%)", "Gross Margin (%)"], null);
      const cash = getAny(summary, ["Cash on Balance Sheet ($mm)", "Cash & Cash Equivalents ($mm)"], null);

      const cards = [
        { label: "Revenue", value: rev ? `$${rev}mm` : "—", sub: "From filings (Period)" },
        { label: "EBITDA", value: ebit ? `$${ebit}mm` : "—", sub: marg ? `Margin: ${marg}` : "" },
        { label: "Total Debt", value: getAny(summary, ["Total Debt ($mm)", "Net Debt ($mm)"], "—") !== "Not Provided"
            ? `$${getAny(summary, ["Total Debt ($mm)", "Net Debt ($mm)"])}mm` : "—",
          sub: getAny(summary, ["Net Debt ($mm)"], null) ? `Net: $${getAny(summary, ["Net Debt ($mm)"])}mm` : "" },
        { label: "Liquidity", value: cash ? `$${cash}mm` : "—", sub: "Cash & equivalents" }
      ];

      container.innerHTML = cards.map(c => `
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-4">
          <div class="text-xs text-gray-500 uppercase tracking-wide">${c.label}</div>
          <div class="mt-1 text-xl font-semibold text-gray-900">${c.value}</div>
          <div class="text-xs text-gray-500 mt-1">${c.sub || ""}</div>
        </div>
      `).join("");
    }

    function renderSnapshot(summary) {
      const company = getAny(summary, ["Company Name", "Borrower / Issuer"], "Dave & Buster’s Entertainment, Inc.");
      const dealTitle = getAny(summary, ["Deal Title"], company);

      document.getElementById("page-title").textContent = `Orion | Credit Tear Sheet — ${dealTitle}`;
      document.getElementById("page-subtitle").textContent =
        "Credit profile generated from filings + agreements. UI fields are mapped to available backend outputs.";

      const dt = new Date();
      const yyyy = dt.getFullYear();
      const mm = String(dt.getMonth()+1).padStart(2,"0");
      const dd = String(dt.getDate()).padStart(2,"0");
      document.getElementById("updated-pill").textContent = `Updated: ${yyyy}-${mm}-${dd}`;

      document.getElementById("snap-company").textContent = company;
      document.getElementById("snap-ticker").textContent = `Ticker: ${safeText(getAny(summary, ["Ticker"], "PLAY"))}`;

      document.getElementById("snap-sector").textContent = safeText(getAny(summary, ["Sector", "Industry"], "—"));
      document.getElementById("snap-subsector").textContent = safeText(getAny(summary, ["Subsector"], "—"));

      document.getElementById("snap-ownership").textContent = safeText(getAny(summary, ["Ownership", "Parent / HoldCo (if any)"], "—"));
      document.getElementById("snap-sponsor").textContent = safeText(getAny(summary, ["Sponsor"], "—"));

      const sp = getAny(summary, ["S&P Rating", "SP Rating"], null);
      const mo = getAny(summary, ["Moody’s Rating", "Moodys Rating"], null);
      const rating = sp || mo || getAny(summary, ["Credit Rating"], "Not Rated / Single-B Equivalent");

      document.getElementById("snap-rating").textContent = rating;
      document.getElementById("snap-rating-note").textContent = safeText(getAny(summary, ["Rating Note"], "Linked to Orion sources"));

      const biz = getAny(summary, ["Business Description", "Segments (names + revenue/profit if disclosed)"], "—");
      document.getElementById("snap-business").innerHTML =
        `<span class="font-semibold">Business Model:</span> ${safeText(biz, "—")}`;
    }

    // IMPORTANT: we map values before rendering
    function buildMappedSummary(rawSummary) {
      const mapped = { ...rawSummary };

      // For every UI field, create the key in mapped summary using whatever backend provides.
      const allFields = new Set();
      [MASTER_SCHEMA, REQUIRED_SCHEMA].forEach(schema => {
        Object.values(schema.sections).forEach(arr => arr.forEach(f => allFields.add(f)));
      });

      for (const uiField of allFields) {
        // Only fill if missing or empty
        if (!Object.prototype.hasOwnProperty.call(mapped, uiField) || String(mapped[uiField] ?? "").trim() === "") {
          const { value } = getAliasedValue(rawSummary, uiField);
          if (value !== "Not Provided") mapped[uiField] = value;
        }
      }

      return mapped;
    }

    function renderSectionedFields(containerId, schema, values, sources, counts, rawSummary) {
      const container = document.getElementById(containerId);
      if (!container) return;

      let html = "";

      for (const [sectionName, fieldList] of Object.entries(schema.sections)) {
        html += `
          <div class="space-y-3">
            <div class="text-sm font-semibold text-gray-900">${sectionName}</div>
        `;

        fieldList.forEach(field => {
          // Use mapped values (so UI looks complete)
          const rawVal = Object.prototype.hasOwnProperty.call(values, field) ? values[field] : "Not Provided";
          const formatted = formatValue(rawVal);

          // Sources/confidence: if exact UI field isn’t present in backend sources,
          // fall back to sources for whichever backend key we used.
          let srcIds = (sources && sources[field]) ? sources[field] : [];

          if ((!srcIds || !srcIds.length) && rawSummary) {
            const { keyUsed } = getAliasedValue(rawSummary, field);
            if (keyUsed && sources && sources[keyUsed]) srcIds = sources[keyUsed];
          }

          const count = (counts && counts[field]) ? counts[field] : (srcIds ? srcIds.length : 0);
          const conf = computeConfidence(count);
          const cClass = confidenceClass(conf);

          const srcLabels = (srcIds || []).map((id, i) => `
            <button
              class="source-pill text-xs underline decoration-dotted hover:text-gray-900"
              data-field="${field}"
              data-file-id="${id}"
              type="button"
            >${i+1}) ${FILE_LABELS[id] || id}</button>
          `).join(", ");

          const sourceLine = `Source(s): ${srcLabels || "n/a"} <span class="${cClass}">(${conf})</span>`;

          html += `
            <div class="rounded-xl border border-gray-200 bg-white px-4 py-3 shadow-sm">
              <div class="flex flex-wrap items-baseline gap-x-2">
                <span class="text-base font-semibold text-gray-900">${field}</span>
                <span class="text-sm font-normal text-gray-700">${formatted}</span>
              </div>
              <div class="mt-1.5 text-xs text-gray-500">${sourceLine}</div>
            </div>
          `;
        });

        html += `</div>`;
      }

      container.innerHTML = html || `<div class="text-xs text-gray-500">No fields returned.</div>`;
    }

    function renderStrategy(summary) {
      const pill = document.getElementById("strategy-pill");
      const detail = document.getElementById("strategy-detail");

      const term = normalizeNumber(getAny(summary, ["Term (Years)", "Term (Years) (if stated)"], null));
      const totalDebt = normalizeNumber(getAny(summary, ["Total Debt ($mm)"], null));
      const commitments = normalizeNumber(getAny(summary, ["Total Commitments ($)"], null));

      let tag = "Flexible SMA / Hybrid";
      let text = "Using available fields (term/commitments) until leverage + covenants are extracted.";

      if (term !== null) {
        if (term >= 7) {
          tag = "Term loan / CLO-compatible tenor";
          text = "Tenor looks long-dated; better aligned with term-loan style risk warehousing / CLO buckets (subject to covenants + leverage).";
        } else {
          tag = "Direct lending / amortizing tenor";
          text = "Shorter tenor; more consistent with direct-lending style hold profiles (subject to covenants + leverage).";
        }
      }

      if (commitments && commitments >= 500000000) {
        text += " Facility size/commitments suggest an institutional syndicated profile.";
      } else if (totalDebt && totalDebt >= 500) {
        text += " Debt size suggests a broadly syndicated / larger-cap credit.";
      }

      pill.textContent = tag;
      detail.textContent = text;
    }

    function wireExports(finalObj) {
      const jsonBtn = document.getElementById("btn-json");
      const csvBtn  = document.getElementById("btn-csv");
      const textBtn = document.getElementById("btn-text");

      const jsonStr = JSON.stringify(finalObj, null, 2);

      if (jsonBtn) jsonBtn.onclick = () => downloadBlob(jsonStr, "dnb_tearsheet.json", "application/json");

      if (csvBtn) {
        const flat = { ...(finalObj.master_summary || {}) };
        const headers = Object.keys(flat);
        const row = headers.map(h => `"${String(flat[h]).replace(/"/g, '""')}"`).join(",");
        const csv = headers.join(",") + "\n" + row;
        csvBtn.onclick = () => downloadBlob(csv, "dnb_tearsheet.csv", "text/csv");
      }

      if (textBtn) {
        const flat = finalObj.master_summary || {};
        let txt = "Orion Credit Tear Sheet\n========================\n\n";
        for (const [k, v] of Object.entries(flat)) {
          txt += `${k}:\n${typeof v === "object" ? JSON.stringify(v, null, 2) : v}\n\n`;
        }
        textBtn.onclick = () => downloadBlob(txt, "dnb_tearsheet.txt", "text/plain");
      }
    }

    /* ==========================
       SNIPPET MODAL
    ========================== */

    function setupSnippetModal() {
      const snippetModal = document.createElement("div");
      snippetModal.id = "snippet-modal";
      snippetModal.className = "fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden";
      snippetModal.innerHTML = `
        <div class="bg-white rounded-xl shadow-xl max-w-xl w-full p-4 text-sm">
          <div id="snippet-title" class="font-semibold mb-2"></div>
          <pre id="snippet-body" class="whitespace-pre-wrap text-xs text-gray-800 max-h-80 overflow-y-auto"></pre>
          <div class="mt-3 text-right">
            <button id="snippet-close" class="px-3 py-1 border rounded-lg text-xs hover:bg-gray-50">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(snippetModal);

      const closeBtn = document.getElementById("snippet-close");
      const titleEl = document.getElementById("snippet-title");
      const bodyEl  = document.getElementById("snippet-body");

      closeBtn.onclick = () => snippetModal.classList.add("hidden");

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") snippetModal.classList.add("hidden");
      });

      document.addEventListener("click", async (e) => {
        const btn = e.target.closest(".source-pill");
        if (!btn) return;

        const field  = btn.dataset.field;
        const fileId = btn.dataset.fileId;

        try {
          const res = await fetch(`${ORION_API_BASE}/field-source-snippet`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ field, file_id: fileId })
          });

          const data = await res.json();
          titleEl.textContent = `${field} — ${FILE_LABELS[fileId] || fileId}`;
          bodyEl.textContent  = data.snippet || "No data.";
          snippetModal.classList.remove("hidden");
        } catch (err) {
          console.error("Error loading snippet:", err);
        }
      });
    }

    /* ==========================
       LOAD MASTER (FastAPI)
    ========================== */

    async function loadFromBackend() {
      const payload = { file_ids: DEAL_FILE_IDS };

      try {
        const res = await fetch(`${ORION_API_BASE}/company-master`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const t = await res.text();
          console.error("HTTP error", res.status, t);
          document.getElementById("page-subtitle").textContent = `Request failed: ${res.status}`;
          return;
        }

        const data = await res.json();

        const rawSummary = data.master_summary || {};
        const sources = data.field_sources || {};
        const counts  = data.field_counts || {};

        // Build a UI-friendly summary using aliases (so it looks filled)
        const summary = buildMappedSummary(rawSummary);

        renderSnapshot(summary);
        renderMetricsStrip(summary);

        renderSectionedFields("master-fields", MASTER_SCHEMA, summary, sources, counts, rawSummary);
        renderSectionedFields("required-fields", REQUIRED_SCHEMA, summary, sources, counts, rawSummary);

        renderFilesUsed();
        renderStrategy(summary);

        wireExports({ master_summary: summary, raw_master_summary: rawSummary, field_sources: sources, field_counts: counts });

        document.getElementById("json-output").textContent = JSON.stringify(summary, null, 2);

      } catch (err) {
        console.error("Error calling /company-master:", err);
        document.getElementById("page-subtitle").textContent = `JavaScript error: ${err}`;
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      setupSnippetModal();
      loadFromBackend();
    });
  </script>

</body>
</html>
