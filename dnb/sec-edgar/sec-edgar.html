<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SEC EDGAR Pull (Ticker → Latest Filings)</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    input, button, select { padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; }
    button { cursor: pointer; }
    .card { border: 1px solid #eee; border-radius: 14px; padding: 14px; margin-top: 14px; }
    .muted { color: #666; font-size: 12px; }
    .err { color: #b00020; font-weight: 700; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px 6px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
    a { text-decoration: none; }
    a:hover { text-decoration: underline; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="flex">

  <!-- SIDEBAR -->
  <div id="sidebar-placeholder"></div>
  <script>
    async function injectSidebar() {
      const res = await fetch("/dnb/sidebar.html");
      document.getElementById("sidebar-placeholder").innerHTML = await res.text();

      window.toggleSection = function(id) {
        const section = document.getElementById(id);
        const icon = document.getElementById("icon-" + id);
        if (!section || !icon) return;

        section.classList.toggle("hidden");
        icon.style.transform = section.classList.contains("hidden") ? "rotate(0deg)" : "rotate(90deg)";
        localStorage.setItem("sidebar-open-section", id);
      };

      const last = localStorage.getItem("sidebar-open-section");
      if (last) {
        const s = document.getElementById(last);
        const i = document.getElementById("icon-" + last);
        if (s && i) {
          s.classList.remove("hidden");
          i.style.transform = "rotate(90deg)";
        }
      }
    }
    injectSidebar();
  </script>

  <!-- MAIN CONTENT -->
  <main class="flex-1 ml-64 p-8 flex flex-col">

  <!-- PAGE HEADER -->
  <h2>SEC EDGAR Pull</h2>
  <div class="muted">
    Uses SEC official endpoints: <code>sec.gov/files/company_tickers.json</code> and <code>data.sec.gov/submissions/</code>.
    (SEC requires a real <code>User-Agent</code> header. Put your email in the code.)
  </div>

  <div class="card">
    <div class="row">
      <label class="muted">Ticker</label>
      <input id="ticker" value="PLAY" style="min-width:120px" />
      <label class="muted">Forms</label>
      <select id="forms">
        <option value="10-K,10-Q,8-K" selected>10-K / 10-Q / 8-K</option>
        <option value="10-K">10-K only</option>
        <option value="10-Q">10-Q only</option>
        <option value="8-K">8-K only</option>
        <option value="ALL">All</option>
      </select>

      <label class="muted">Limit</label>
      <select id="limit">
        <option value="10">10</option>
        <option value="25" selected>25</option>
        <option value="50">50</option>
      </select>

      <button id="go">Fetch filings</button>
    </div>

    <div id="status" class="muted" style="margin-top:10px;">Ready.</div>
    <div id="out"></div>
  </div>

  <script>
    // IMPORTANT: SEC asks for a descriptive User-Agent with contact info.
    // Put YOUR real email here.

    const $ = (id) => document.getElementById(id);

    function padCIK(cik) {
      const s = String(cik).replace(/^0+/, "");
      return s.padStart(10, "0");
    }

    function stripDashes(accession) {
      return String(accession).replace(/-/g, "");
    }

    function setStatus(msg) {
      $("status").textContent = msg;
    }

    function renderError(msg) {
      $("out").innerHTML = `<div class="err">${msg}</div>`;
    }

    async function fetchJSON(url) {
      const res = await fetch(url, { headers: SEC_HEADERS });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return await res.json();
    }

    async function tickerToCIK(ticker) {
      // Official SEC ticker mapping:
      // Returns an object list keyed by index: { cik_str, ticker, title }
      const mapUrl = "https://www.sec.gov/files/company_tickers.json";
      const data = await fetchJSON(mapUrl);

      const t = ticker.trim().toUpperCase();
      for (const k of Object.keys(data)) {
        if ((data[k].ticker || "").toUpperCase() === t) {
          return {
            cik: data[k].cik_str,
            title: data[k].title
          };
        }
      }
      return null;
    }

    function filterForms(form, wantedSet) {
      if (wantedSet.has("ALL")) return true;
      return wantedSet.has(form);
    }

    function buildFilingLinks(cik10, accession, primaryDoc) {
      // Filing index page:
      const accNoNoDash = stripDashes(accession);
      const indexUrl = `https://www.sec.gov/Archives/edgar/data/${Number(cik10)}/${accNoNoDash}/${accession}-index.html`;

      // Direct primary doc (often HTML):
      const primaryUrl = `https://www.sec.gov/Archives/edgar/data/${Number(cik10)}/${accNoNoDash}/${primaryDoc}`;

      return { indexUrl, primaryUrl };
    }

    function renderTable(companyTitle, cik10, rows) {
      if (!rows.length) {
        $("out").innerHTML = `<div class="muted">No filings found for your filters.</div>`;
        return;
      }

      const html = `
        <div class="muted">Company: <b>${companyTitle}</b> • CIK: <b>${cik10}</b></div>
        <table>
          <thead>
            <tr>
              <th>Filed</th>
              <th>Form</th>
              <th>Accession</th>
              <th>Links</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td>${r.filed || "—"}</td>
                <td><b>${r.form || "—"}</b></td>
                <td><code>${r.accession || "—"}</code></td>
                <td>
                  <a href="${r.indexUrl}" target="_blank" rel="noopener">Index</a>
                  &nbsp;•&nbsp;
                  <a href="${r.primaryUrl}" target="_blank" rel="noopener">Primary</a>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
      $("out").innerHTML = html;
    }

    async function loadFilings() {
      $("out").innerHTML = "";
      const ticker = $("ticker").value.trim().toUpperCase();
      const forms = $("forms").value;
      const limit = Number($("limit").value || 25);
    
      if (!ticker) return renderError("Enter a ticker.");
    
      try {
        setStatus("Fetching from Orion API…");
    
        const url = new URL("/api/sec-edgar", window.location.origin);
        url.searchParams.set("ticker", ticker);
        url.searchParams.set("forms", forms);
        url.searchParams.set("limit", String(limit));
    
        const res = await fetch(url.toString(), {
          headers: { "Accept": "application/json" }
        });
    
        const data = await res.json();
    
        if (!res.ok) {
          renderError(data?.error || `HTTP ${res.status}`);
          setStatus("Failed.");
          return;
        }
    
        renderTable(data.company || ticker, data.cik10 || "—", data.rows || []);
        setStatus("Done.");
      } catch (e) {
        renderError(`Error: ${e?.message || e}`);
        setStatus("Failed.");
      }
    }

    $("go").addEventListener("click", loadFilings);

    // Auto-load for PLAY on first open
    loadFilings();
  </script>

  <!-- Chat Logic -->
  <script>
    const input = document.getElementById("chatInput");
    const btn = document.getElementById("sendBtn");
    const windowEl = document.getElementById("chatWindow");

    function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      const msg = document.createElement("div");
      msg.className = "flex items-start gap-3";

      msg.innerHTML = `
        <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-semibold">J</div>
        <div>
          <div class="font-semibold text-gray-800">You <span class="text-gray-400 text-xs ml-2">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></div>
          <div class="bg-blue-50 p-3 rounded-lg text-sm text-gray-800 max-w-xl border border-blue-200">
            ${text}
          </div>
        </div>
      `;

      windowEl.appendChild(msg);
      windowEl.scrollTop = windowEl.scrollHeight;

      input.value = "";
    }

    btn.onclick = sendMessage;
    input.addEventListener("keypress", e => {
      if (e.key === "Enter") sendMessage();
    });
  </script>
    <!--Ask Orion Bot -->
    <div id="orion-chat-include"></div>
    <script>
      async function loadOrionChat() {
        const res = await fetch("/dnb/includes/orion-chat.html");
        const html = await res.text();
    
        // Insert into DOM
        const container = document.getElementById("orion-chat-include");
        container.innerHTML = html;
    
        // --- EXECUTE SCRIPTS ---
        const scripts = container.querySelectorAll("script");
        scripts.forEach(oldScript => {
          const newScript = document.createElement("script");
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          document.body.appendChild(newScript);
          oldScript.remove();
        });
      }
    
      loadOrionChat();
    </script>
</body>
</html>
