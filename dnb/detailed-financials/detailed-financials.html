<section class="card historicals" aria-labelledby="hist-title">
  <style>
    .card.historicals{
      border:1px solid #e6e6e6;border-radius:14px;padding:16px;background:#fff;
      max-width:980px;margin-top:24px
    }
    .card.historicals h2{margin:0 0 10px;font:600 18px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .subnote{margin:0 0 12px;color:#666;font:12px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .table-wrap{overflow:auto;border:1px solid #eee;border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:760px}
    thead th{
      position:sticky;top:0;background:#fafafa;z-index:1;
      text-align:right;padding:12px;border-bottom:1px solid #eee;
      font:600 12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#333
    }
    thead th:first-child{text-align:left}
    tbody td{
      padding:12px;border-bottom:1px solid #f0f0f0;
      font:13px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111
    }
    tbody tr:last-child td{border-bottom:0}
    tbody td:first-child{font-weight:600;text-align:left;color:#222;white-space:nowrap}
    tbody td:not(:first-child){text-align:right;white-space:nowrap}
    .muted{color:#666;font-weight:500}
    .group td{
      background:#fcfcfc;font-weight:700;color:#111;border-bottom:1px solid #eaeaea
    }
  </style>

  <h2 id="hist-title">Detailed Historical Financials</h2>
  <p class="subnote">Latest 4 annual periods (from Postgres export) · USD millions unless noted</p>

  <div class="table-wrap" role="region" aria-label="Historical financials table">
    <table id="histTable">
      <thead>
        <tr id="histHeadRow">
          <th scope="col">Metric</th>
          <!-- populated from CSV headers -->
        </tr>
      </thead>
      <tbody id="histBody">
        <tr><td class="muted" colspan="5">Loading…</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    // 1) Put the CSV on your site and point this to it
    // Example: /dnb/data/PLAY_financials_export_202512291235.csv
    const CSV_URL = "/dnb/data/PLAY_financials_export_202512291235.csv";

    // 2) formatting knobs
    const FORMAT = {
      currencyDecimals: 1,   // e.g., 134.4
      ratioDecimals: 2,      // e.g., 3.32
      pctDecimals: 2         // e.g., 21.50%
    };

    function parseCSV(text) {
      const lines = text.replace(/\r/g, "").split("\n").filter(l => l.trim().length);
      const headers = splitCSVLine(lines[0]).map(h => h.trim());
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = splitCSVLine(lines[i]);
        const obj = {};
        headers.forEach((h, idx) => obj[h] = (cols[idx] ?? "").trim());
        rows.push(obj);
      }
      return { headers, rows };

      // minimal CSV splitter handling quotes
      function splitCSVLine(line) {
        const out = [];
        let cur = "", inQ = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"' ) {
            if (inQ && line[i+1] === '"') { cur += '"'; i++; }
            else inQ = !inQ;
          } else if (ch === "," && !inQ) {
            out.push(cur); cur = "";
          } else {
            cur += ch;
          }
        }
        out.push(cur);
        return out;
      }
    }

    function groupLabel(metric) {
      if (metric.startsWith("IS:")) return "Income Statement";
      if (metric.startsWith("CF:")) return "Cash Flow";
      if (metric.startsWith("BS:")) return "Balance Sheet";
      if (metric.startsWith("DER:")) return "Leverage & Ratios";
      return "Other";
    }

    function cleanMetricName(metric) {
      const idx = metric.indexOf(":");
      return idx >= 0 ? metric.slice(idx + 1).trim() : metric.trim();
    }

    function toNumber(x) {
      if (x === null || x === undefined) return null;
      const s = String(x).trim();
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function fmt(metric, n) {
      if (n === null) return "—";

      const m = metric.toLowerCase();

      // percent-like
      if (m.includes("margin") || m.includes("growth") || m.includes("roa")) {
        return (n * 100).toFixed(FORMAT.pctDecimals) + "%";
      }

      // ratio-like
      if (m.includes("leverage") || m.includes("debt /") || m.includes("coverage") || m.includes(" / ")) {
        return n.toFixed(FORMAT.ratioDecimals);
      }

      // default: money/amount
      return n.toLocaleString(undefined, {
        minimumFractionDigits: FORMAT.currencyDecimals,
        maximumFractionDigits: FORMAT.currencyDecimals
      });
    }

    async function loadFinancials() {
      const bodyEl = document.getElementById("histBody");
      const headRow = document.getElementById("histHeadRow");

      try {
        const res = await fetch(CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`CSV fetch failed: ${res.status}`);
        const csvText = await res.text();

        const { headers, rows } = parseCSV(csvText);

        // build header (everything except "metric")
        const valueCols = headers.filter(h => h !== "metric");
        // clear any existing
        while (headRow.children.length > 1) headRow.removeChild(headRow.lastChild);

        valueCols.forEach(h => {
          const th = document.createElement("th");
          th.scope = "col";
          th.textContent = h; // Annual_1, Annual_2, ...
          headRow.appendChild(th);
        });

        // group rows
        const groups = {};
        rows.forEach(r => {
          const metric = r.metric || "";
          const g = groupLabel(metric);
          if (!groups[g]) groups[g] = [];
          groups[g].push(r);
        });

        // render
        bodyEl.innerHTML = "";
        const groupOrder = ["Income Statement", "Cash Flow", "Balance Sheet", "Leverage & Ratios", "Other"];

        groupOrder.forEach(gname => {
          const arr = groups[gname];
          if (!arr || !arr.length) return;

          const trg = document.createElement("tr");
          trg.className = "group";
          const tdg = document.createElement("td");
          tdg.colSpan = 1 + valueCols.length;
          tdg.textContent = gname;
          trg.appendChild(tdg);
          bodyEl.appendChild(trg);

          arr.forEach(r => {
            const tr = document.createElement("tr");

            const metricFull = r.metric || "";
            const td0 = document.createElement("td");
            td0.textContent = cleanMetricName(metricFull);
            tr.appendChild(td0);

            valueCols.forEach(c => {
              const td = document.createElement("td");
              const n = toNumber(r[c]);
              td.textContent = fmt(metricFull, n);
              tr.appendChild(td);
            });

            bodyEl.appendChild(tr);
          });
        });

      } catch (e) {
        bodyEl.innerHTML = `<tr><td class="muted" colspan="5">Failed to load CSV: ${e.message}</td></tr>`;
      }
    }

    loadFinancials();
  </script>
</section>
