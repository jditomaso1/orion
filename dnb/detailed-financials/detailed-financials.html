<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Financials — Orion</title>

  <link rel="icon" type="image/png"
        href="https://raw.githubusercontent.com/jditomaso1/private-credit-marketing/main/img/favicon.png?v=2" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f6f8;
    }
  </style>
</head>

<body class="flex">

  <!-- SIDEBAR -->
  <div id="sidebar-placeholder"></div>
  <script>
    async function injectSidebar() {
      const res = await fetch("/dnb/sidebar.html");
      document.getElementById("sidebar-placeholder").innerHTML = await res.text();

      window.toggleSection = function(id) {
        const section = document.getElementById(id);
        const icon = document.getElementById("icon-" + id);
        if (!section || !icon) return;

        section.classList.toggle("hidden");
        icon.style.transform = section.classList.contains("hidden") ? "rotate(0deg)" : "rotate(90deg)";
        localStorage.setItem("sidebar-open-section", id);
      };

      const last = localStorage.getItem("sidebar-open-section");
      if (last) {
        const s = document.getElementById(last);
        const i = document.getElementById("icon-" + last);
        if (s && i) {
          s.classList.remove("hidden");
          i.style.transform = "rotate(90deg)";
        }
      }
    }
    injectSidebar();
  </script>

  <!-- MAIN CONTENT -->
  <main class="flex-1 ml-64 p-8 flex flex-col">

    <!-- CSV-DRIVEN FINANCIALS TABLE -->
    <section class="card historicals" aria-labelledby="hist-title">
      <style>
        .card.historicals{
          border:1px solid #e6e6e6;border-radius:14px;padding:16px;background:#fff;
          max-width:980px;margin-top:24px
        }
        .card.historicals h2{margin:0 0 10px;font:600 18px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial}
        .subnote{margin:0 0 12px;color:#666;font:12px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
        .table-wrap{overflow:auto;border:1px solid #eee;border-radius:12px}
        table{width:100%;border-collapse:separate;border-spacing:0;min-width:760px}
        thead th{
          position:sticky;top:0;background:#fafafa;z-index:1;
          text-align:right;padding:12px;border-bottom:1px solid #eee;
          font:600 12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#333
        }
        thead th:first-child{text-align:left}
        tbody td{
          padding:12px;border-bottom:1px solid #f0f0f0;
          font:13px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111
        }
        tbody tr:last-child td{border-bottom:0}
        tbody td:first-child{font-weight:600;text-align:left;color:#222;white-space:nowrap}
        tbody td:not(:first-child){text-align:right;white-space:nowrap}
        .muted{color:#666;font-weight:500}
        .group td{
          background:#fcfcfc;font-weight:700;color:#111;border-bottom:1px solid #eaeaea
        }

        /* usability: keep Metric column visible when scrolling horizontally */
        thead th:first-child,
        tbody td:first-child{
          position: sticky;
          left: 0;
          z-index: 2;
          background: #fff;
        }
        thead th:first-child{
          z-index: 3;
          background: #fafafa;
        }
      </style>

      <h2 id="hist-title">Detailed Historical Financials</h2>
      <p class="subnote">Latest 4 annual periods (from Postgres export) · USD millions unless noted</p>

      <div class="table-wrap" role="region" aria-label="Historical financials table">
        <table id="histTable">
          <thead>
            <tr id="histHeadRow">
              <th scope="col">Metric</th>
            </tr>
          </thead>
          <tbody id="histBody">
            <tr><td class="muted" colspan="5">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <script>
        // Update this filename to your latest export
        const CSV_URL = "/dnb/data/moodys_shadow_ratings.csv";

        const FORMAT = { currencyDecimals: 1, ratioDecimals: 2, pctDecimals: 2 };

        const GROUP_TITLES = new Set([
          "Income Statement",
          "Cash Flow",
          "Balance Sheet",
          "Leverage & Ratios",
          "Credit Metrics and Ratios" // <- your CSV has this too
        ]);

        function splitCSVLine(line) {
          const out = [];
          let cur = "", inQ = false;
          for (let i = 0; i < line.length; i++) {
            const ch = line[i];
            if (ch === '"') {
              if (inQ && line[i+1] === '"') { cur += '"'; i++; }
              else inQ = !inQ;
            } else if (ch === "," && !inQ) {
              out.push(cur); cur = "";
            } else {
              cur += ch;
            }
          }
          out.push(cur);
          return out;
        }

        function parseCSV(text) {
          const lines = text.replace(/\r/g, "").split("\n").filter(l => l.trim().length);
          const headers = splitCSVLine(lines[0]).map(h => h.trim());
          const rows = [];
          for (let i = 1; i < lines.length; i++) {
            const cols = splitCSVLine(lines[i]);
            const obj = {};
            headers.forEach((h, idx) => obj[h] = (cols[idx] ?? "").trim());
            rows.push(obj);
          }
          return { headers, rows };
        }

        function cleanMetricName(metric) {
          const idx = metric.indexOf(":");
          return idx >= 0 ? metric.slice(idx + 1).trim() : metric.trim();
        }

        function isMissingToken(s) {
          const t = String(s ?? "").trim();
          if (!t) return true;
          const low = t.toLowerCase();
          return (
            t === "—" || t === "-" ||
            low === "na" || low === "n/a" ||
            low === "null" || low === "none"
          );
        }

        // IMPORTANT FIX:
        // If a cell already has "x" or "%" in the CSV, show it as-is.
        // Otherwise parse as a number and format.
        function renderCell(metric, raw) {
          if (raw === null || raw === undefined) return "—";
          const s0 = String(raw).trim();
          if (isMissingToken(s0)) return "—";

          // Show pre-formatted multiples and percents directly (your CSV uses "3.3 x", "21.5%")
          if (/%/.test(s0)) return s0;
          if (/\bx\b/i.test(s0)) return s0;

          // Otherwise parse numeric (handle commas)
          const n = Number(s0.replace(/,/g, ""));
          if (!Number.isFinite(n)) return "—";

          const m = String(metric || "").toLowerCase();

          // If you ever export ratios as plain numbers (no "x"), keep this logic
          const isRatioMetric =
            m.startsWith("der:") ||
            m.includes("leverage") ||
            m.includes("coverage") ||
            m.includes("debt /") ||
            m.includes(" / ");

          if (isRatioMetric) return n.toFixed(FORMAT.ratioDecimals);

          return n.toLocaleString(undefined, {
            minimumFractionDigits: FORMAT.currencyDecimals,
            maximumFractionDigits: FORMAT.currencyDecimals
          });
        }

        async function loadFinancials() {
          const bodyEl = document.getElementById("histBody");
          const headRow = document.getElementById("histHeadRow");

          try {
            const res = await fetch(CSV_URL, { cache: "no-store" });
            if (!res.ok) throw new Error(`CSV fetch failed: ${res.status}`);
            const csvText = await res.text();

            const { headers, rows } = parseCSV(csvText);

            // metric column is first header (e.g., "Annual Financials")
            const metricCol = headers[0];
            const valueCols = headers.slice(1);

            // Build header
            while (headRow.children.length > 1) headRow.removeChild(headRow.lastChild);
            valueCols.forEach(h => {
              const th = document.createElement("th");
              th.scope = "col";
              th.textContent = h;
              headRow.appendChild(th);
            });

            bodyEl.innerHTML = "";

            let currentGroup = null;

            function renderGroupRow(title) {
              const trg = document.createElement("tr");
              trg.className = "group";
              const tdg = document.createElement("td");
              tdg.colSpan = 1 + valueCols.length;
              tdg.textContent = title;
              trg.appendChild(tdg);
              bodyEl.appendChild(trg);
            }

            // Fallback grouping if your CSV doesn't include group header rows
            function groupLabelByPrefix(metric) {
              if (metric.startsWith("IS:")) return "Income Statement";
              if (metric.startsWith("CF:")) return "Cash Flow";
              if (metric.startsWith("BS:")) return "Balance Sheet";
              if (metric.startsWith("DER:")) return "Leverage & Ratios";
              return "Other";
            }

            let sawGroupHeaders = false;

            for (const r of rows) {
              const metricRaw = String(r[metricCol] ?? "").trim();
              if (!metricRaw) continue;

              const allBlank = valueCols.every(c => isMissingToken(r[c]));

              // group header row in CSV
              if (GROUP_TITLES.has(metricRaw) && allBlank) {
                sawGroupHeaders = true;
                currentGroup = metricRaw;
                renderGroupRow(currentGroup);
                continue;
              }

              // ignore separator/blank rows
              if (allBlank && !GROUP_TITLES.has(metricRaw)) continue;

              // If no explicit group headers exist, group by IS:/CF:/BS:/DER:
              if (!sawGroupHeaders) {
                const g = groupLabelByPrefix(metricRaw);
                if (g !== currentGroup) {
                  currentGroup = g;
                  renderGroupRow(currentGroup);
                }
              } else {
                // If group headers exist but we haven’t hit one yet, start in Other
                if (!currentGroup) {
                  currentGroup = "Other";
                  renderGroupRow(currentGroup);
                }
              }

              const tr = document.createElement("tr");

              const td0 = document.createElement("td");
              td0.textContent = cleanMetricName(metricRaw);
              tr.appendChild(td0);

              valueCols.forEach(c => {
                const td = document.createElement("td");
                td.textContent = renderCell(metricRaw, r[c]);  // <- key fix
                tr.appendChild(td);
              });

              bodyEl.appendChild(tr);
            }

            if (!bodyEl.children.length) {
              const colCount = headRow.children.length || 2;
              bodyEl.innerHTML = `<tr><td class="muted" colspan="${colCount}">No rows found in CSV.</td></tr>`;
            }

          } catch (e) {
            const colCount = document.getElementById("histHeadRow").children.length || 2;
            bodyEl.innerHTML = `<tr><td class="muted" colspan="${colCount}">Failed to load CSV: ${e.message}</td></tr>`;
          }
        }

        loadFinancials();
      </script>
    </section>

  </main>

  <!-- Ask Orion Bot -->
  <div id="orion-chat-include"></div>
  <script>
    async function loadOrionChat() {
      const res = await fetch("/dnb/includes/orion-chat.html");
      const html = await res.text();

      const container = document.getElementById("orion-chat-include");
      container.innerHTML = html;

      const scripts = container.querySelectorAll("script");
      scripts.forEach(oldScript => {
        const newScript = document.createElement("script");
        if (oldScript.src) newScript.src = oldScript.src;
        else newScript.textContent = oldScript.textContent;
        document.body.appendChild(newScript);
        oldScript.remove();
      });
    }
    loadOrionChat();
  </script>

</body>
</html>
