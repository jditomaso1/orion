<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>What-If — Ratings Migration | Orion</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png"
        href="https://raw.githubusercontent.com/jditomaso1/private-credit-marketing/main/img/favicon.png?v=2" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: Poppins, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f5f6f8; }
    .card { background:#fff; border:1px solid #e8e8e8; border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.06); }
    .muted { color:#6b7280; }
    .mono { font-variant-numeric: tabular-nums; }
    .chip { border:1px solid #e5e7eb; background:#fafafa; border-radius:999px; padding:.2rem .55rem; font-size:12px; color:#374151; }
    .btn { border:1px solid #111827; background:#111827; color:#fff; border-radius:10px; padding:.55rem .8rem; font-weight:600; font-size:13px; }
    .btn:hover { opacity:.92; }
    .btn2 { border:1px solid #e5e7eb; background:#fff; color:#111827; border-radius:10px; padding:.55rem .8rem; font-weight:600; font-size:13px; }
    .btn2:hover { background:#fafafa; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px 10px; border-bottom:1px solid #f0f0f0; font-size:13px; }
    th { text-align:left; color:#374151; font-weight:600; }
    td { color:#111827; }
    .badge { display:inline-flex; align-items:center; justify-content:center; min-width:34px; height:22px; padding:0 8px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid #e5e7eb; background:#fff; }
    .b-good { color:#065f46; background:#ecfdf5; border-color:#a7f3d0; }
    .b-warn { color:#92400e; background:#fffbeb; border-color:#fde68a; }
    .b-bad  { color:#991b1b; background:#fef2f2; border-color:#fecaca; }
    .small { font-size:12px; }
    .tile { border:1px solid #e5e7eb; border-radius:14px; background:#fff; padding:12px; }
    .tile .k { font-size:11px; color:#6b7280; }
    .tile .v { margin-top:2px; font-weight:700; }
    .divider { height:1px; background:#eee; }
    .note { font-size:12px; color:#6b7280; line-height:1.35; }
    input, select { border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; width:100%; font-size:13px; background:#fff; }
    input:focus, select:focus { outline:none; border-color:#c7c7c7; box-shadow:0 0 0 3px rgba(17,24,39,.06); }
  </style>
</head>

<body class="flex text-gray-900">

  <!-- SIDEBAR -->
  <div id="sidebar-placeholder"></div>
  <script>
    async function injectSidebar() {
      try {
        const res = await fetch("/dnb/sidebar.html");
        document.getElementById("sidebar-placeholder").innerHTML = await res.text();

        window.toggleSection = function(id) {
          const section = document.getElementById(id);
          const icon = document.getElementById("icon-" + id);
          if (!section || !icon) return;
          section.classList.toggle("hidden");
          icon.style.transform = section.classList.contains("hidden") ? "rotate(0deg)" : "rotate(90deg)";
          localStorage.setItem("sidebar-open-section", id);
        };

        const last = localStorage.getItem("sidebar-open-section");
        if (last) {
          const section = document.getElementById(last);
          const icon = document.getElementById("icon-" + last);
          if (section && icon) {
            section.classList.remove("hidden");
            icon.style.transform = "rotate(90deg)";
          }
        }
      } catch (e) {
        // allow page to run without sidebar in dev
      }
    }
    injectSidebar();
  </script>

  <!-- MAIN -->
  <main class="flex-1 ml-64 p-8 max-w-[1250px]">

    <!-- HEADER -->
    <section class="flex items-start justify-between gap-4 flex-wrap">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight">Ratings Migration</h1>
        <p class="muted mt-2 text-sm">
          <span class="chip">PLAY · Dave &amp; Buster’s</span>
          <span class="chip">Latest LTM snapshot</span>
          <span class="chip">What-If scenarios</span>
        </p>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnReset" class="btn2">Reset to LTM</button>
        <button id="btnRecalc" class="btn">Recalculate</button>
      </div>
    </section>

    <!-- TOP TILES -->
    <section class="mt-6 card p-5">
      <div class="flex items-start justify-between gap-3 flex-wrap">
        <div>
          <div class="text-sm font-semibold">What…If?</div>
          <div class="note mt-1">Move a few inputs → scorecard + shadow rating updates.</div>
        </div>
        <div class="flex items-center gap-2">
          <span class="chip" id="asOfChip">As of latest upload</span>
          <span class="chip">Quant-only</span>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
        <div class="tile"><div class="k">Revenue (LTM)</div><div class="v mono" id="tRevenue">—</div></div>
        <div class="tile"><div class="k">EBITDA (LTM)</div><div class="v mono" id="tEbitda">—</div></div>
        <div class="tile"><div class="k">Debt (proxy)</div><div class="v mono" id="tDebt">—</div></div>
        <div class="tile"><div class="k">Leases</div><div class="v mono" id="tLeases">—</div></div>
        <div class="tile"><div class="k">Adj Debt/EBITDA</div><div class="v mono" id="tLevAdj">—</div></div>
        <div class="tile"><div class="k">EBIT/Interest</div><div class="v mono" id="tCov">—</div></div>

        <div class="tile"><div class="k">RCF</div><div class="v mono" id="tRcf">—</div></div>
        <div class="tile"><div class="k">RCF/Debt (Adj)</div><div class="v mono" id="tRcfDebt">—</div></div>
        <div class="tile"><div class="k">ROA</div><div class="v mono" id="tRoa">—</div></div>
        <div class="tile"><div class="k">Adj Debt</div><div class="v mono" id="tAdjDebt">—</div></div>
        <div class="tile"><div class="k">Quant Rating</div><div class="v mono" id="tRating">—</div></div>
        <div class="tile"><div class="k">Score</div><div class="v mono" id="tScore">—</div></div>
      </div>
    </section>

    <!-- TWO COLUMN BODY -->
    <section class="mt-6 grid grid-cols-12 gap-6">

      <!-- LEFT: SCORECARD SNAPSHOT -->
      <div class="col-span-12 lg:col-span-7 card p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-base font-semibold">Moody’s-Style Quant Scorecard (Snapshot)</div>
            <div class="note mt-1">
              Uses lease-adjusted leverage (Debt+Leases) + basic coverage &amp; cash flow. Thresholds are editable in the code.
            </div>
          </div>
          <div class="text-right">
            <div class="text-xs muted">Quant-only Shadow Rating</div>
            <div class="text-3xl font-bold mt-1 mono" id="snapLetter">—</div>
            <div class="chip mt-2 inline-block mono" id="snapScoreChip">Score: —</div>
          </div>
        </div>

        <div class="mt-4 overflow-auto">
          <table>
            <thead>
              <tr>
                <th style="min-width:210px;">Metric</th>
                <th style="min-width:110px;">Value</th>
                <th style="min-width:90px;">Bucket</th>
                <th style="min-width:90px;">Points</th>
                <th>Driver note</th>
              </tr>
            </thead>
            <tbody id="scorecardBody"></tbody>
          </table>
        </div>

        <div class="divider my-4"></div>

        <div class="grid sm:grid-cols-2 gap-3">
          <div class="tile">
            <div class="k">Computed (from your chosen inputs)</div>
            <div class="mt-2 space-y-1 small mono" id="computedBlock">—</div>
          </div>
          <div class="tile">
            <div class="k">Notes</div>
            <div class="note mt-2">
              • “Score” is a 0 → 4.10 point scale (sum of weights).<br/>
              • “Rating” is mapped from score (custom thresholds below).<br/>
              • Swap in your exact Moody’s banding later—this UI stays the same.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: WHAT-IF PANEL -->
      <aside class="col-span-12 lg:col-span-5 card p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-base font-semibold">What-If (basic)</div>
            <div class="note mt-1">Tweak inputs → scorecard + shadow rating updates.</div>
          </div>
          <button id="btnReset2" class="btn2">Reset to LTM</button>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs muted">Revenue (USD bn)</label>
            <input id="inRevenue" type="number" step="0.0001" />
          </div>
          <div>
            <label class="text-xs muted">EBITDA (USD bn)</label>
            <input id="inEbitda" type="number" step="0.0001" />
          </div>
          <div>
            <label class="text-xs muted">Funded Debt (USD bn)</label>
            <input id="inDebt" type="number" step="0.0001" />
          </div>
          <div>
            <label class="text-xs muted">Lease Liabilities (USD bn)</label>
            <input id="inLeases" type="number" step="0.0001" />
          </div>
          <div>
            <label class="text-xs muted">EBIT (USD bn)</label>
            <input id="inEbit" type="number" step="0.0001" />
          </div>
          <div>
            <label class="text-xs muted">Interest Expense (USD bn)</label>
            <input id="inInterest" type="number" step="0.0001" />
          </div>
          <div>
            <label class="text-xs muted">RCF (USD bn)</label>
            <input id="inRcf" type="number" step="0.0001" />
          </div>
          <div>
            <label class="text-xs muted">ROA (%)</label>
            <input id="inRoa" type="number" step="0.01" />
          </div>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="btnRun" class="btn">Recalculate</button>
          <button id="btnSoftReset" class="btn2">Undo changes</button>
        </div>

        <div class="mt-4 tile">
          <div class="k">Outputs</div>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <div class="tile" style="padding:10px;">
              <div class="k">Quant Rating</div>
              <div class="v mono" id="outRating">—</div>
            </div>
            <div class="tile" style="padding:10px;">
              <div class="k">Score</div>
              <div class="v mono" id="outScore">—</div>
            </div>
          </div>

          <div class="divider my-3"></div>

          <div class="small mono space-y-1" id="outComputed">—</div>
        </div>

        <div class="note mt-3">
          Tip: this is designed to become an Orion module: when the latest financials land, prefill these inputs automatically.
        </div>
      </aside>

    </section>

    <!-- Ask Orion Bot (optional include) -->
    <div id="orion-chat-include"></div>
    <script>
      async function loadOrionChat() {
        try {
          const res = await fetch("/dnb/includes/orion-chat.html");
          const html = await res.text();
          const container = document.getElementById("orion-chat-include");
          container.innerHTML = html;

          const scripts = container.querySelectorAll("script");
          scripts.forEach(oldScript => {
            const newScript = document.createElement("script");
            if (oldScript.src) newScript.src = oldScript.src;
            else newScript.textContent = oldScript.textContent;
            document.body.appendChild(newScript);
            oldScript.remove();
          });
        } catch (e) {}
      }
      loadOrionChat();
    </script>

  </main>

  <script>
    /******************************************************************
     * 1) LTM DATA (PLAY) — from your latest provided snapshot
     *    Units: USD mm (we convert to bn for inputs).
     ******************************************************************/
    const PLAY_LTM_MM = {
      ticker: "PLAY",
      name: "Dave & Buster’s",
      revenue: 2107.7,
      ebitda: 391.1,
      ebit: 135.7,
      interest: 142.7,
      debt: 1492.9,               // funded debt proxy
      leases: 2637.3,             // lease liabilities
      rcf: 247.4,                 // retained cash flow
      roa_pct: 0.01               // ROA (%) as provided (0.01%)
    };

    // Keep a copy to undo changes (soft reset)
    let lastApplied = null;

    /******************************************************************
     * 2) SCORING MODEL (simple + editable)
     *    Score scale is 0 → 4.10 (sum of weights below).
     ******************************************************************/
    const WEIGHTS = {
      scale: 0.60,        // revenue
      profitability: 0.60,// ROA
      cashflow: 0.60,     // RCF / Adj Debt
      leverage: 1.50,     // Adj Debt / EBITDA
      coverage: 0.80      // EBIT / Interest
    };
    const SCORE_MAX = Object.values(WEIGHTS).reduce((a,b)=>a+b,0);

    // Bands (edit these later to match your Moody’s restaurant pdf exactly)
    const BANDS = {
      revenue_bn:      { best: 10.0, worst: 0.0, higherIsBetter: true }, // 0–10bn scale anchor
      roa_pct:         { best: 10.0, worst: 0.0, higherIsBetter: true }, // 0–10%
      rcf_debt_pct:    { best: 25.0, worst: -5.0, higherIsBetter: true },// -5% to 25%
      lev_adj:         { best: 4.0,  worst: 12.0, higherIsBetter: false },// 4x to 12x
      cov_ebit_int:    { best: 4.0,  worst: 0.5, higherIsBetter: true }  // 0.5x to 4.0x
    };

    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    // best = value that scores 1.0; worst = value that scores 0.0
    function interp(v, best, worst, higherIsBetter){
      if (!isFinite(v)) return 0;
      if (best === worst) return 0;
      let t;
      if (higherIsBetter) t = (v - worst) / (best - worst);
      else t = (worst - v) / (worst - best);
      return clamp01(t);
    }

    // Score -> Rating mapping (edit thresholds any time)
    function scoreToRating(score){
      // score in [0..4.10]
      if (score >= 3.50) return "Ba1";
      if (score >= 3.05) return "Ba2";
      if (score >= 2.65) return "Ba3";
      if (score >= 2.25) return "B1";
      if (score >= 1.85) return "B2";
      if (score >= 1.45) return "B3";
      if (score >= 1.05) return "Caa1";
      if (score >= 0.70) return "Caa2";
      return "Caa3";
    }

    // Value -> simple “bucket” label for the scorecard table (cosmetic, not Moody’s official)
    function bucketLabel(metricKey, value){
      // you can replace these with your exact Moody’s bucket cutoffs
      if (!isFinite(value)) return { label:"—", cls:"badge" };

      const mk = metricKey;

      // revenue (bn)
      if (mk === "revenue_bn") {
        if (value >= 5) return { label:"Ba", cls:"badge b-good" };
        if (value >= 1) return { label:"B",  cls:"badge b-warn" };
        return { label:"Caa", cls:"badge b-bad" };
      }
      // ROA (%)
      if (mk === "roa_pct") {
        if (value >= 5) return { label:"Ba", cls:"badge b-good" };
        if (value >= 1) return { label:"B",  cls:"badge b-warn" };
        return { label:"Caa", cls:"badge b-bad" };
      }
      // RCF / Adj Debt (%)
      if (mk === "rcf_debt_pct") {
        if (value >= 15) return { label:"Ba", cls:"badge b-good" };
        if (value >= 5)  return { label:"B",  cls:"badge b-warn" };
        return { label:"Caa", cls:"badge b-bad" };
      }
      // Adj Debt/EBITDA (x) lower is better
      if (mk === "lev_adj") {
        if (value <= 6)  return { label:"Ba", cls:"badge b-good" };
        if (value <= 9)  return { label:"B",  cls:"badge b-warn" };
        return { label:"Caa", cls:"badge b-bad" };
      }
      // EBIT/Interest (x)
      if (mk === "cov_ebit_int") {
        if (value >= 2)  return { label:"Ba", cls:"badge b-good" };
        if (value >= 1)  return { label:"B",  cls:"badge b-warn" };
        return { label:"Caa", cls:"badge b-bad" };
      }
      return { label:"—", cls:"badge" };
    }

    /******************************************************************
     * 3) Derived metrics + scoring
     ******************************************************************/
    function deriveFromInputsBN(inp){
      const revenue_bn = inp.revenue_bn;
      const ebitda_bn  = inp.ebitda_bn;
      const debt_bn    = inp.debt_bn;
      const leases_bn  = inp.leases_bn;
      const ebit_bn    = inp.ebit_bn;
      const interest_bn= inp.interest_bn;
      const rcf_bn     = inp.rcf_bn;
      const roa_pct    = inp.roa_pct;

      const adj_debt_bn = debt_bn + leases_bn;
      const lev_adj = (ebitda_bn > 0) ? (adj_debt_bn / ebitda_bn) : Infinity;
      const cov_ebit_int = (interest_bn > 0) ? (ebit_bn / interest_bn) : Infinity;
      const rcf_debt_pct = (adj_debt_bn > 0) ? (rcf_bn / adj_debt_bn) * 100 : 0;

      // subscores 0..1
      const s_scale = interp(revenue_bn, BANDS.revenue_bn.best, BANDS.revenue_bn.worst, BANDS.revenue_bn.higherIsBetter);
      const s_roa   = interp(roa_pct,    BANDS.roa_pct.best,    BANDS.roa_pct.worst,    BANDS.roa_pct.higherIsBetter);
      const s_rcf   = interp(rcf_debt_pct,BANDS.rcf_debt_pct.best,BANDS.rcf_debt_pct.worst,BANDS.rcf_debt_pct.higherIsBetter);
      const s_lev   = interp(lev_adj,    BANDS.lev_adj.best,    BANDS.lev_adj.worst,    BANDS.lev_adj.higherIsBetter);
      const s_cov   = interp(cov_ebit_int,BANDS.cov_ebit_int.best,BANDS.cov_ebit_int.worst,BANDS.cov_ebit_int.higherIsBetter);

      // points
      const p_scale = WEIGHTS.scale * s_scale;
      const p_roa   = WEIGHTS.profitability * s_roa;
      const p_rcf   = WEIGHTS.cashflow * s_rcf;
      const p_lev   = WEIGHTS.leverage * s_lev;
      const p_cov   = WEIGHTS.coverage * s_cov;

      const score = p_scale + p_roa + p_rcf + p_lev + p_cov;
      const rating = scoreToRating(score);

      return {
        revenue_bn, ebitda_bn, debt_bn, leases_bn, ebit_bn, interest_bn, rcf_bn, roa_pct,
        adj_debt_bn, lev_adj, cov_ebit_int, rcf_debt_pct,
        subs: { s_scale, s_roa, s_rcf, s_lev, s_cov },
        pts:  { p_scale, p_roa, p_rcf, p_lev, p_cov },
        score, rating
      };
    }

    /******************************************************************
     * 4) UI helpers
     ******************************************************************/
    function fmtBn(x, d=4){ return isFinite(x) ? (x.toFixed(d).replace(/0+$/,"").replace(/\.$/,"")) : "—"; }
    function fmtMmFromBn(xbn, d=1){
      if (!isFinite(xbn)) return "—";
      const mm = xbn * 1000;
      return "$" + mm.toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}) + "mm";
    }
    function fmtX(x, d=2){ return isFinite(x) ? x.toFixed(d) + "x" : "—"; }
    function fmtPct(x, d=2){ return isFinite(x) ? x.toFixed(d) + "%" : "—"; }

    function setInputsFromLTM(){
      // Convert mm -> bn for inputs
      const revenue_bn = PLAY_LTM_MM.revenue / 1000;
      const ebitda_bn  = PLAY_LTM_MM.ebitda  / 1000;
      const debt_bn    = PLAY_LTM_MM.debt    / 1000;
      const leases_bn  = PLAY_LTM_MM.leases  / 1000;
      const ebit_bn    = PLAY_LTM_MM.ebit    / 1000;
      const interest_bn= PLAY_LTM_MM.interest/ 1000;
      const rcf_bn     = PLAY_LTM_MM.rcf     / 1000;

      inRevenue.value  = revenue_bn.toFixed(4);
      inEbitda.value   = ebitda_bn.toFixed(4);
      inDebt.value     = debt_bn.toFixed(4);
      inLeases.value   = leases_bn.toFixed(4);
      inEbit.value     = ebit_bn.toFixed(4);
      inInterest.value = interest_bn.toFixed(4);
      inRcf.value      = rcf_bn.toFixed(4);
      inRoa.value      = PLAY_LTM_MM.roa_pct.toFixed(2);

      lastApplied = {
        revenue_bn, ebitda_bn, debt_bn, leases_bn, ebit_bn, interest_bn, rcf_bn, roa_pct: PLAY_LTM_MM.roa_pct
      };
    }

    function readInputs(){
      const revenue_bn = parseFloat(inRevenue.value)  || 0;
      const ebitda_bn  = parseFloat(inEbitda.value)   || 0;
      const debt_bn    = parseFloat(inDebt.value)     || 0;
      const leases_bn  = parseFloat(inLeases.value)   || 0;
      const ebit_bn    = parseFloat(inEbit.value)     || 0;
      const interest_bn= parseFloat(inInterest.value) || 0;
      const rcf_bn     = parseFloat(inRcf.value)      || 0;
      const roa_pct    = parseFloat(inRoa.value)      || 0;
      return { revenue_bn, ebitda_bn, debt_bn, leases_bn, ebit_bn, interest_bn, rcf_bn, roa_pct };
    }

    function renderAll(){
      const inp = readInputs();
      const d = deriveFromInputsBN(inp);

      // Top tiles (mm formatting like your screenshot)
      tRevenue.textContent = fmtMmFromBn(d.revenue_bn, 1);
      tEbitda.textContent  = fmtMmFromBn(d.ebitda_bn,  1);
      tDebt.textContent    = fmtMmFromBn(d.debt_bn,    1);
      tLeases.textContent  = fmtMmFromBn(d.leases_bn,  1);
      tAdjDebt.textContent = fmtMmFromBn(d.adj_debt_bn,1);
      tLevAdj.textContent  = fmtX(d.lev_adj, 2);
      tCov.textContent     = fmtX(d.cov_ebit_int, 2);
      tRcf.textContent     = fmtMmFromBn(d.rcf_bn, 1);
      tRcfDebt.textContent = fmtPct(d.rcf_debt_pct, 2);
      tRoa.textContent     = fmtPct(d.roa_pct, 2);
      tRating.textContent  = d.rating;
      tScore.textContent   = d.score.toFixed(2);

      // Snapshot headline
      snapLetter.textContent = d.rating;
      snapScoreChip.textContent = "Score: " + d.score.toFixed(2) + " / " + SCORE_MAX.toFixed(2);

      // Right outputs
      outRating.textContent = d.rating;
      outScore.textContent  = d.score.toFixed(2) + " / " + SCORE_MAX.toFixed(2);

      outComputed.innerHTML = `
        <div>Total Debt (Adj) = Debt + Leases: <b>${fmtBn(d.adj_debt_bn,4)} bn</b></div>
        <div>Debt/EBITDA (Adj): <b>${fmtX(d.lev_adj,2)}</b></div>
        <div>RCF/Debt (Adj): <b>${fmtPct(d.rcf_debt_pct,2)}</b></div>
        <div>EBIT/Interest: <b>${fmtX(d.cov_ebit_int,2)}</b></div>
      `;

      computedBlock.innerHTML = `
        <div>Total Debt (Adj) = Debt + Leases: <b>${fmtBn(d.adj_debt_bn,4)} bn</b></div>
        <div>Debt/EBITDA (Adj): <b>${fmtX(d.lev_adj,2)}</b></div>
        <div>RCF/Debt (Adj): <b>${fmtPct(d.rcf_debt_pct,2)}</b></div>
        <div>EBIT/Interest: <b>${fmtX(d.cov_ebit_int,2)}</b></div>
      `;

      // Scorecard table
      const rows = [
        {
          key: "revenue_bn",
          label: "Revenue ($bn)",
          value: d.revenue_bn,
          valueFmt: d.revenue_bn.toFixed(2),
          points: d.pts.p_scale,
          w: WEIGHTS.scale,
          note: "Scale anchor"
        },
        {
          key: "roa_pct",
          label: "ROA (%)",
          value: d.roa_pct,
          valueFmt: d.roa_pct.toFixed(2) + "%",
          points: d.pts.p_roa,
          w: WEIGHTS.profitability,
          note: "Profitability proxy"
        },
        {
          key: "rcf_debt_pct",
          label: "RCF / Debt (Adj.) (%)",
          value: d.rcf_debt_pct,
          valueFmt: d.rcf_debt_pct.toFixed(2) + "%",
          points: d.pts.p_rcf,
          w: WEIGHTS.cashflow,
          note: "Cash flow vs (Debt+Leases)"
        },
        {
          key: "lev_adj",
          label: "Debt / EBITDA (Adj.) (x)",
          value: d.lev_adj,
          valueFmt: isFinite(d.lev_adj) ? d.lev_adj.toFixed(2) + "x" : "—",
          points: d.pts.p_lev,
          w: WEIGHTS.leverage,
          note: "Leverage incl. leases"
        },
        {
          key: "cov_ebit_int",
          label: "EBIT / Interest (x)",
          value: d.cov_ebit_int,
          valueFmt: isFinite(d.cov_ebit_int) ? d.cov_ebit_int.toFixed(2) + "x" : "—",
          points: d.pts.p_cov,
          w: WEIGHTS.coverage,
          note: "Coverage (reported)"
        }
      ];

      scorecardBody.innerHTML = "";
      rows.forEach(r => {
        const b = bucketLabel(r.key, r.value);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="font-medium">${r.label}</td>
          <td class="mono">${r.valueFmt}</td>
          <td><span class="${b.cls}">${b.label}</span></td>
          <td class="mono">${r.points.toFixed(2)} <span class="muted small">/ ${r.w.toFixed(2)}</span></td>
          <td class="muted">${r.note}</td>
        `;
        scorecardBody.appendChild(tr);
      });
    }

    /******************************************************************
     * 5) Wire buttons + init
     ******************************************************************/
    btnRecalc.onclick = () => { lastApplied = readInputs(); renderAll(); };
    btnRun.onclick    = () => { lastApplied = readInputs(); renderAll(); };
    btnReset.onclick  = () => { setInputsFromLTM(); renderAll(); };
    btnReset2.onclick = () => { setInputsFromLTM(); renderAll(); };

    btnSoftReset.onclick = () => {
      if (!lastApplied) { setInputsFromLTM(); renderAll(); return; }
      inRevenue.value  = lastApplied.revenue_bn.toFixed(4);
      inEbitda.value   = lastApplied.ebitda_bn.toFixed(4);
      inDebt.value     = lastApplied.debt_bn.toFixed(4);
      inLeases.value   = lastApplied.leases_bn.toFixed(4);
      inEbit.value     = lastApplied.ebit_bn.toFixed(4);
      inInterest.value = lastApplied.interest_bn.toFixed(4);
      inRcf.value      = lastApplied.rcf_bn.toFixed(4);
      inRoa.value      = lastApplied.roa_pct.toFixed(2);
      renderAll();
    };

    // Recalc on Enter
    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); lastApplied = readInputs(); renderAll(); }
    });

    // Init
    setInputsFromLTM();
    renderAll();
  </script>

</body>
</html>
