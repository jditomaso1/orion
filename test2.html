<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Orion Neural Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#0b0f16; }
    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
    }
  </style>
</head>

<body class="min-h-screen text-white">
  <div class="max-w-6xl mx-auto px-4 py-4">
    <div class="flex items-center justify-between mb-3">
      <div>
        <div class="text-xl font-semibold">Orion Neural Map</div>
        <div class="text-xs text-white/60">vectors (dots) · hover for details</div>
      </div>
      <div class="text-xs text-white/60">
        Data: <span class="font-mono">GET /neural-map</span>
      </div>
    </div>

    <div class="card p-3">
      <div id="status" class="text-xs text-white/70 mb-2">Loading…</div>
      <div id="plot" style="width:100%; height:78vh;"></div>
    </div>
  </div>

  <script>
    const DATA_URL = "http://localhost:8000/neural-map";;

    async function fetchPoints() {
      const res = await fetch(DATA_URL, { headers: { "Accept": "application/json" }});
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      return res.json(); // <-- IMPORTANT: your API returns an ARRAY
    }

    function safe(v) {
      return (v === null || v === undefined) ? "" : String(v);
    }

    function render(points) {
      const status = document.getElementById("status");
      status.textContent = `Loaded ${points.length} vectors`;

      const xs = points.map(p => p.x);
      const ys = points.map(p => p.y);

      // Put hover fields into customdata for clean templates.
      // If later you add e.g. p.file_name / p.ticker / p.doc_type, just add them here.
      const customdata = points.map(p => ([
        safe(p.label),         // 0
        safe(p.id),            // 1
        safe(p.group),         // 2
        (typeof p.x === "number" ? p.x.toFixed(4) : safe(p.x)), // 3
        (typeof p.y === "number" ? p.y.toFixed(4) : safe(p.y)), // 4
        // Optional future fields (won't break if missing):
        safe(p.file_name || (p.metadata && p.metadata.file_name)), // 5
        safe(p.ticker || (p.metadata && p.metadata.ticker)),       // 6
        safe(p.doc_type || (p.metadata && p.metadata.doc_type)),   // 7
        safe(p.period_end || (p.metadata && p.metadata.period_end)), // 8
        safe(p.anchor || (p.metadata && p.metadata.anchor))        // 9
      ]));

      const trace = {
        type: "scattergl",
        mode: "markers",
        x: xs,
        y: ys,
        customdata,
        marker: { size: 9, color: "rgba(53, 208, 186, 0.95)" },
        hovertemplate:
          "<b>%{customdata[0]}</b><br>" +
          "<span style='opacity:0.75'>id:</span> <span style='font-family:monospace'>%{customdata[1]}</span><br>" +
          "<span style='opacity:0.75'>group:</span> %{customdata[2]}<br>" +
          "<span style='opacity:0.75'>x:</span> %{customdata[3]} &nbsp; <span style='opacity:0.75'>y:</span> %{customdata[4]}" +
          // If you later add metadata to the API, these lines will start populating automatically:
          "<br><br><span style='opacity:0.85'><b>metadata</b></span><br>" +
          "file: %{customdata[5]}<br>" +
          "ticker: %{customdata[6]}<br>" +
          "type: %{customdata[7]}<br>" +
          "period_end: %{customdata[8]}<br>" +
          "anchor: %{customdata[9]}<br>" +
          "<extra></extra>",
        name: "vectors"
      };

      const layout = {
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        margin: { l: 10, r: 10, t: 10, b: 10 },
        showlegend: false,
        xaxis: { visible: false },
        yaxis: { visible: false },
        hoverlabel: {
          bgcolor: "rgba(20,20,25,0.95)",
          bordercolor: "rgba(255,255,255,0.15)",
          font: { color: "#fff", size: 12 }
        }
      };

      Plotly.newPlot("plot", [trace], layout, { responsive: true, displayModeBar: false });
    }

    (async () => {
      const status = document.getElementById("status");
      try {
        const points = await fetchPoints();

        if (!Array.isArray(points)) {
          status.textContent = "Expected /neural-map to return an array, but got something else.";
          return;
        }

        const filtered = points.filter(p => typeof p.x === "number" && typeof p.y === "number");
        if (!filtered.length) {
          status.textContent = "No points with numeric x/y found.";
          return;
        }

        render(filtered);
      } catch (err) {
        console.error(err);
        status.textContent = `Error: ${err.message}`;
      }
    })();
  </script>
</body>
</html>
